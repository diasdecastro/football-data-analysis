<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xG Calculator - Multi-Model Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        /* Model Selector */
        .model-selector {
            background: #f7fafc;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .selector-group {
            flex: 1;
            min-width: 250px;
        }

        .selector-group label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .selector-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .selector-group select:hover {
            border-color: #667eea;
        }

        .selector-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: .3s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .model-info {
            background: #edf2f7;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #4a5568;
            min-width: 200px;
        }

        .model-info strong {
            color: #2d3748;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .pitch-container {
            position: relative;
        }

        .pitch-label {
            text-align: center;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        #pitch-canvas-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            display: inline-block;
        }

        #pitch {
            width: 100%;
            height: auto;
            border: 3px solid #2d3748;
            border-radius: 10px;
            cursor: crosshair;
            background: #48bb78;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: block;
        }

        #heatmap-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            object-fit: fill;
        }

        #heatmap-overlay.active {
            opacity: 0.7;
        }

        .info-panel {
            background: #f7fafc;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .xg-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .xg-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .xg-percentage {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .quality-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 10px;
            font-size: 0.95em;
        }

        .quality-excellent { background: #48bb78; color: white; }
        .quality-good { background: #4299e1; color: white; }
        .quality-average { background: #ed8936; color: white; }
        .quality-poor { background: #f56565; color: white; }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .stat-label {
            color: #718096;
            font-weight: 500;
        }

        .stat-value {
            color: #2d3748;
            font-weight: 600;
        }

        .shot-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #f56565;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            pointer-events: none;
            z-index: 10;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #f56565;
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #2f855a;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border-left: 4px solid #48bb78;
            display: none;
        }

        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #718096;
            font-size: 0.9em;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öΩ Expected Goals (xG) Calculator</h1>
        <p class="subtitle">Multi-Model Demo with Heatmap Visualization</p>

        <!-- Model Selector -->
        <div class="model-selector">
            <div class="selector-group">
                <label for="model-select">üî¨ Select Model:</label>
                <select id="model-select">
                    <option value="">Loading models...</option>
                </select>
            </div>
            
            <div class="toggle-group">
                <label for="heatmap-toggle" style="color: #4a5568; font-weight: 600;">üó∫Ô∏è Show Heatmap:</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="heatmap-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="model-info" id="model-info">
                <strong>Current:</strong> <span id="current-model-name">-</span>
            </div>
        </div>

        <div class="spinner" id="heatmap-spinner"></div>
        <div class="success-message" id="success-message"></div>

        <div class="main-content">
            <!-- Pitch Section -->
            <div class="pitch-container">
                <div class="pitch-label">üèüÔ∏è Football Pitch (Click to Place Shot)</div>
                <div id="pitch-canvas-container">
                    <canvas id="pitch" width="700" height="467"></canvas>
                    <img id="heatmap-overlay" src="" alt="xG Heatmap">
                </div>
            </div>

            <!-- Info Panel -->
            <div class="info-panel">
                <div class="info-section">
                    <h3>üéØ Prediction</h3>
                    <div class="xg-display">
                        <div class="xg-percentage">Expected Goals</div>
                        <div class="xg-value" id="xg-value">--</div>
                        <div class="xg-percentage" id="xg-percentage">Click on pitch</div>
                        <div id="quality-badge"></div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>üìä Shot Details</h3>
                    <div class="stat-row">
                        <span class="stat-label">Distance to Goal</span>
                        <span class="stat-value" id="distance-value">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Shooting Angle</span>
                        <span class="stat-value" id="angle-value">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Position</span>
                        <span class="stat-value" id="position-value">--</span>
                    </div>
                </div>

                <div class="info-section">
                    <h3>‚ÑπÔ∏è About This Demo</h3>
                    <p style="color: #4a5568; line-height: 1.6; font-size: 0.95em;">
                        Compare different xG model versions and visualize probability distributions 
                        across the pitch. Toggle the heatmap to see how shot location affects xG.
                    </p>
                </div>
            </div>
        </div>

        <div class="error-message" id="error-message"></div>

        <div class="footer">
            <p>Powered by StatsBomb Open Data | Built with FastAPI & scikit-learn</p>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';
        const PITCH_WIDTH = 120;
        const PITCH_HEIGHT = 80;

        // State
        let currentModel = null;
        let shotMarker = null;
        let heatmapVisible = false;

        // Canvas setup
        const canvas = document.getElementById('pitch');
        const ctx = canvas.getContext('2d');
        const heatmapOverlay = document.getElementById('heatmap-overlay');
        const heatmapToggle = document.getElementById('heatmap-toggle');
        const modelSelect = document.getElementById('model-select');

        // Convert pitch coordinates to canvas pixels
        function pitchToCanvas(pitchX, pitchY) {
            const canvasX = (pitchX / PITCH_WIDTH) * canvas.width;
            const canvasY = (pitchY / PITCH_HEIGHT) * canvas.height;
            return { x: canvasX, y: canvasY };
        }

        // Draw the football pitch using exact StatsBomb coordinates
        function drawPitch() {
            const width = canvas.width;
            const height = canvas.height;

            // Grass background
            ctx.fillStyle = '#48bb78';
            ctx.fillRect(0, 0, width, height);

            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.lineCap = 'square';

            // Outer boundary - exactly at (0,0) to (120,80)
            ctx.strokeRect(0, 0, width, height);

            // Center line - at x=60
            const centerLine = pitchToCanvas(60, 0);
            ctx.beginPath();
            ctx.moveTo(centerLine.x, 0);
            ctx.lineTo(centerLine.x, height);
            ctx.stroke();

            // Center circle - at (60, 40) with radius ~9.15 yards
            const centerCircle = pitchToCanvas(60, 40);
            const circleRadius = (9.15 / PITCH_WIDTH) * width; // Scale to canvas
            ctx.beginPath();
            ctx.arc(centerCircle.x, centerCircle.y, circleRadius, 0, 2 * Math.PI);
            ctx.stroke();

            // Center spot
            ctx.beginPath();
            ctx.arc(centerCircle.x, centerCircle.y, 2, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();

            // Right penalty box - from (102, 18) to (120, 62)
            const penaltyBoxTL = pitchToCanvas(102, 18);
            const penaltyBoxBR = pitchToCanvas(120, 62);
            ctx.strokeRect(
                penaltyBoxTL.x,
                penaltyBoxTL.y,
                penaltyBoxBR.x - penaltyBoxTL.x,
                penaltyBoxBR.y - penaltyBoxTL.y
            );

            // Right six-yard box - from (114, 30) to (120, 50)
            const sixYardTL = pitchToCanvas(114, 30);
            const sixYardBR = pitchToCanvas(120, 50);
            ctx.strokeRect(
                sixYardTL.x,
                sixYardTL.y,
                sixYardBR.x - sixYardTL.x,
                sixYardBR.y - sixYardTL.y
            );

            // Penalty spot - at (108, 40)
            const penaltySpot = pitchToCanvas(108, 40);
            ctx.beginPath();
            ctx.arc(penaltySpot.x, penaltySpot.y, 2, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();

            // Goal - at x=120, from y=36 to y=44 (8 yards wide)
            const goalTop = pitchToCanvas(120, 36);
            const goalBottom = pitchToCanvas(120, 44);
            ctx.strokeStyle = '#e53e3e';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(goalTop.x, goalTop.y);
            ctx.lineTo(goalBottom.x, goalBottom.y);
            ctx.stroke();

            // Goal label
            const goalLabel = pitchToCanvas(116, 40);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('GOAL', goalLabel.x, goalLabel.y);

            // Optional: Add coordinate labels for debugging
            // ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            // ctx.font = '10px Arial';
            // ctx.fillText('(0,0)', 5, 10);
            // ctx.fillText('(120,0)', width - 30, 10);
            // ctx.fillText('(0,80)', 5, height - 5);
            // ctx.fillText('(120,80)', width - 35, height - 5);
        }

        // Load available models
        async function loadModels() {
            try {
                const response = await fetch(`${API_BASE_URL}/xg/models`);
                const data = await response.json();
                
                modelSelect.innerHTML = '';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.model_id;
                    option.textContent = model.display_name || model.name || model.model_id;
                    if (model.model_id === data.current_model) {
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                });

                currentModel = data.current_model;
                updateModelInfo(data.models.find(m => m.model_id === currentModel));
                
                console.log(`‚úÖ Loaded ${data.count} models`);
            } catch (error) {
                console.error('Error loading models:', error);
                showError('Failed to load models. Make sure API server is running.');
            }
        }

        // Update model info display
        function updateModelInfo(model) {
            if (!model) return;
            document.getElementById('current-model-name').textContent = 
                model.display_name || model.name || model.model_id;
        }

        // Change model
        modelSelect.addEventListener('change', async (e) => {
            const modelId = e.target.value;
            try {
                const response = await fetch(
                    `${API_BASE_URL}/xg/models/select?model_id=${modelId}`,
                    { method: 'POST' }
                );
                const data = await response.json();
                
                currentModel = modelId;
                updateModelInfo(data.selected_model);
                showSuccess(`Switched to model: ${data.selected_model.display_name || data.selected_model.name}`);
                
                // Reload heatmap if visible
                if (heatmapVisible) {
                    loadHeatmap();
                }
            } catch (error) {
                console.error('Error switching model:', error);
                showError('Failed to switch model');
            }
        });

        // Load heatmap
        async function loadHeatmap() {
            const spinner = document.getElementById('heatmap-spinner');
            spinner.style.display = 'block';
            
            try {
                const modelParam = currentModel ? `?model_id=${currentModel}&resolution=60` : '?resolution=60';
                const response = await fetch(`${API_BASE_URL}/xg/heatmap${modelParam}`);
                
                if (!response.ok) throw new Error('Failed to generate heatmap');
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                heatmapOverlay.src = url;
                heatmapOverlay.classList.add('active');
                
                console.log('‚úÖ Heatmap loaded');
            } catch (error) {
                console.error('Error loading heatmap:', error);
                showError('Failed to load heatmap');
            } finally {
                spinner.style.display = 'none';
            }
        }

        // Toggle heatmap
        heatmapToggle.addEventListener('change', (e) => {
            heatmapVisible = e.target.checked;
            
            if (heatmapVisible) {
                loadHeatmap();
            } else {
                heatmapOverlay.classList.remove('active');
            }
        });

        // Convert canvas coordinates to pitch coordinates
        function canvasToPitch(canvasX, canvasY) {
            const x = (canvasX / canvas.width) * PITCH_WIDTH;
            const y = (canvasY / canvas.height) * PITCH_HEIGHT;
            return { x: x, y: y };
        }

        // Place shot marker
        function placeMarker(canvasX, canvasY) {
            if (shotMarker) shotMarker.remove();
            
            shotMarker = document.createElement('div');
            shotMarker.className = 'shot-marker';
            const container = document.getElementById('pitch-canvas-container');
            const rect = canvas.getBoundingClientRect();
            shotMarker.style.left = canvasX + 'px';
            shotMarker.style.top = canvasY + 'px';
            container.appendChild(shotMarker);
        }

        // Update UI
        function updateUI(data, pitchCoords) {
            document.getElementById('xg-value').textContent = data.xG.toFixed(4);
            document.getElementById('xg-percentage').textContent = `${(data.xG * 100).toFixed(2)}% chance`;
            document.getElementById('distance-value').textContent = `${data.shot_distance.toFixed(1)} yards`;
            document.getElementById('angle-value').textContent = `${data.shot_angle.toFixed(1)}¬∞`;
            document.getElementById('position-value').textContent = `(${pitchCoords.x.toFixed(1)}, ${pitchCoords.y.toFixed(1)})`;

            const qualityBadge = document.getElementById('quality-badge');
            const qualityClass = `quality-${data.quality.toLowerCase()}`;
            qualityBadge.className = `quality-badge ${qualityClass}`;
            qualityBadge.textContent = `${data.quality} Shot`;
        }

        // Show messages
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }

        // Calculate xG
        async function calculateXG(pitchX, pitchY) {
            try {
                const modelParam = currentModel ? `?model_id=${currentModel}` : '';
                const response = await fetch(`${API_BASE_URL}/xg/score${modelParam}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x: pitchX, y: pitchY })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error calculating xG:', error);
                showError(`Failed to calculate xG: ${error.message}`);
                return null;
            }
        }

        // Handle pitch click
        canvas.addEventListener('click', async (event) => {
            const rect = canvas.getBoundingClientRect();
            const canvasX = event.clientX - rect.left;
            const canvasY = event.clientY - rect.top;

            const pitchCoords = canvasToPitch(canvasX, canvasY);
            placeMarker(canvasX, canvasY);

            canvas.classList.add('loading');
            const result = await calculateXG(pitchCoords.x, pitchCoords.y);
            canvas.classList.remove('loading');

            if (result) updateUI(result, pitchCoords);
        });

        // Initialize
        drawPitch();
        loadModels();

        // Test API connection
        fetch(`${API_BASE_URL}/health`)
            .then(response => response.json())
            .then(data => console.log('‚úÖ API connected:', data))
            .catch(error => {
                console.error('‚ùå API connection failed:', error);
                showError('Warning: Cannot connect to API server');
            });
    </script>
</body>
</html>